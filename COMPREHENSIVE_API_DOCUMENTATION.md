# ç»¼åˆåˆ†æ API æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

å·²æˆåŠŸå°†ç»¼åˆåˆ†æåŠŸèƒ½æ·»åŠ åˆ° FastAPI æœåŠ¡ä¸­ï¼Œå¯é€šè¿‡ HTTP API è°ƒç”¨è¿›è¡Œæ•°æ®åˆ†æã€‚

## ğŸ”— API ç«¯ç‚¹

```
POST /api/search/comprehensive-analysis
```

## ğŸ“¥ è¯·æ±‚æ ¼å¼

### è¯·æ±‚ä½“ç»“æ„

```json
{
  "metric_api_address": "http://your-api-server:8083",
  "JWT": "Bearer your_jwt_token",
  "data": {
    "rows": [...],              // å¯é€‰ï¼šç›´æ¥æä¾›æ•°æ®è¡Œ
    "datasKey": "xxx",          // å¯é€‰ï¼šä»æ•°æ®æ± è·å–æ•°æ®
    "target_columns": ["é”€å”®é¢", "å®¢æˆ·æ•°"],  // å¯é€‰ï¼šè¦åˆ†æçš„æŒ‡æ ‡åˆ—
    "date_column": "æœˆä»½",      // å¯é€‰ï¼šæ—¥æœŸåˆ—å
    "group_by": ["åŒºåŸŸ", "äº§å“"],  // å¯é€‰ï¼šåˆ†ç»„å­—æ®µ
    "filter_obj": {}            // å¯é€‰ï¼šè¿‡æ»¤æ¡ä»¶
  }
}
```

### å‚æ•°è¯´æ˜

| å‚æ•°                    | ç±»å‹   | å¿…å¡« | è¯´æ˜                             |
| ----------------------- | ------ | ---- | -------------------------------- |
| `metric_api_address`  | string | æ˜¯   | API åŸºç¡€åœ°å€                     |
| `JWT`                 | string | æ˜¯   | JWT è®¤è¯ token                   |
| `data.rows`           | array  | å¦*  | åŸå§‹æ•°æ®è¡Œæ•°ç»„                   |
| `data.datasKey`       | string | å¦*  | æ•°æ®æ± çš„ key                     |
| `data.target_columns` | array  | å¦   | è¦åˆ†æçš„æŒ‡æ ‡åˆ—åï¼Œä¸ºç©ºåˆ™è‡ªåŠ¨æ¨æ–­ |
| `data.date_column`    | string | å¦   | æ—¥æœŸåˆ—åï¼Œç”¨äºè¶‹åŠ¿åˆ†æ           |
| `data.group_by`       | array  | å¦   | åˆ†ç»„å­—æ®µåˆ—è¡¨                     |
| `data.filter_obj`     | object | å¦   | è¿‡æ»¤æ¡ä»¶                         |

**æ³¨æ„ï¼š** `rows` å’Œ `datasKey` äºŒé€‰ä¸€ï¼Œä¼˜å…ˆä½¿ç”¨ `rows`

## ğŸ“¤ å“åº”æ ¼å¼

### æˆåŠŸå“åº”

```json
{
  "success": true,
  "comprehensive_result": {
    "ä¸æ»¡å£°éŸ³æ€»æ•°": {
      "basic_stats": {
        "mean": 115.0,
        "median": 110.0,
        "std": 28.72,
        "skewness": 0.23,
        "kurtosis": -0.48,
        "min": 80.0,
        "max": 170.0,
        "count": 9
      },
      "quartiles": {
        "Q1": 90.0,
        "Q2": 110.0,
        "Q3": 135.0
      },
      "distribution": {
        "stats": {...},
        "histogram": {...},
        "boxplot": {...}
      },
      "trend": {
        "stats": {
          "slope": 5.56,
          "intercept": 98.33,
          "r_squared": 0.6234,
          "latest_value": 170.0,
          "max_value": 170.0,
          "min_value": 80.0,
          "mean": 115.0,
          "std": 28.72
        },
        "plot_data": {
          "type": "trend",
          "dates": ["2024-01", "2024-02", "2024-03"],
          "values": [100, 120, 110],
          "trendline": [98.33, 103.89, 109.45],
          "r_squared": 0.6234
        }
      },
      "groupby_agg": [
        {
          "äº§å“ç±»å‹": "äº§å“A",
          "ä¸æ»¡å£°éŸ³æ€»æ•°_sum": 330.0,
          "ä¸æ»¡å£°éŸ³æ€»æ•°_mean": 110.0,
          "ä¸æ»¡å£°éŸ³æ€»æ•°_max": 120.0,
          "ä¸æ»¡å£°éŸ³æ€»æ•°_min": 100.0,
          "ä¸æ»¡å£°éŸ³æ€»æ•°_std": 8.16,
          "ä¸æ»¡å£°éŸ³æ€»æ•°_median": 110.0,
          "count": 3
        }
      ],
      "group_trend": [
        {
          "group": {"äº§å“ç±»å‹": "äº§å“A"},
          "stats": {
            "slope": 5.0,
            "intercept": 105.0,
            "r_squared": 0.5,
            "latest_value": 110.0,
            "max_value": 120.0,
            "min_value": 100.0,
            "mean": 110.0,
            "std": 8.16
          },
          "plot_data": {...}
        }
      ]
    }
  },
  "took": 1234
}
```

### å¤±è´¥å“åº”

```json
{
  "success": false,
  "error": "é”™è¯¯æè¿°ä¿¡æ¯",
  "comprehensive_result": null,
  "took": 123
}
```

## ğŸ¯ åŠŸèƒ½è¯´æ˜

### æ”¯æŒçš„åˆ†æåŠŸèƒ½

| åŠŸèƒ½          | è¯´æ˜                                            | å­—æ®µå           |
| ------------- | ----------------------------------------------- | ---------------- |
| âœ… åŸºç¡€ç»Ÿè®¡   | å‡å€¼ã€ä¸­ä½æ•°ã€æ ‡å‡†å·®ã€ååº¦ã€å³°åº¦ã€æœ€å¤§æœ€å°å€¼    | `basic_stats`  |
| âœ… å››åˆ†ä½æ•°   | Q1(25%), Q2(50%), Q3(75%)                       | `quartiles`    |
| âœ… åˆ†å¸ƒåˆ†æ   | ç›´æ–¹å›¾ã€ç®±çº¿å›¾æ•°æ®                              | `distribution` |
| âœ… è¶‹åŠ¿åˆ†æ   | çº¿æ€§å›å½’ã€RÂ²æ‹Ÿåˆåº¦ã€è¶‹åŠ¿çº¿                     | `trend`        |
| âœ… åˆ†ç»„èšåˆ   | æŒ‰ç»´åº¦åˆ†ç»„çš„ç»Ÿè®¡ï¼ˆsum/mean/max/min/std/medianï¼‰ | `groupby_agg`  |
| âœ… åˆ†ç»„è¶‹åŠ¿   | å„åˆ†ç»„çš„è¶‹åŠ¿åˆ†æ                                | `group_trend`  |
| âŒ å¼‚å¸¸å€¼æ£€æµ‹ | å·²è¿‡æ»¤ï¼Œä¸è¿”å›                                  | -                |
| âŒ å¯¹æ¯”åˆ†æ   | å·²è¿‡æ»¤ï¼Œä¸è¿”å›                                  | -                |

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåŸºç¡€åˆ†æï¼ˆç›´æ¥æä¾›æ•°æ®ï¼‰

```python
import requests

url = "http://localhost:8083/api/search/comprehensive-analysis"
data = {
    "metric_api_address": "http://localhost:8083",
    "JWT": "Bearer xxx",
    "data": {
        "rows": [
            {"æœˆä»½": "2024-01", "é”€å”®é¢": 1000, "åŒºåŸŸ": "åä¸œ"},
            {"æœˆä»½": "2024-02", "é”€å”®é¢": 1200, "åŒºåŸŸ": "åä¸œ"},
            {"æœˆä»½": "2024-03", "é”€å”®é¢": 1100, "åŒºåŸŸ": "åä¸œ"}
        ],
        "target_columns": ["é”€å”®é¢"],
        "date_column": "æœˆä»½"
    }
}

response = requests.post(url, json=data)
result = response.json()

if result["success"]:
    print(f"å¹³å‡é”€å”®é¢: {result['comprehensive_result']['é”€å”®é¢']['basic_stats']['mean']}")
    print(f"è¶‹åŠ¿æ–œç‡: {result['comprehensive_result']['é”€å”®é¢']['trend']['stats']['slope']}")
```

### ç¤ºä¾‹ 2ï¼šåˆ†ç»„åˆ†æ

```python
data = {
    "metric_api_address": "http://localhost:8083",
    "JWT": "Bearer xxx",
    "data": {
        "rows": [...],
        "target_columns": ["ä¸æ»¡å£°éŸ³æ€»æ•°"],
        "date_column": "æœˆä»½",
        "group_by": ["äº§å“ç±»å‹"]  # æŒ‰äº§å“ç±»å‹åˆ†ç»„
    }
}

response = requests.post(url, json=data)
result = response.json()

# è®¿é—®åˆ†ç»„èšåˆç»“æœ
for group in result['comprehensive_result']['ä¸æ»¡å£°éŸ³æ€»æ•°']['groupby_agg']:
    print(f"{group['äº§å“ç±»å‹']}: å¹³å‡ {group['ä¸æ»¡å£°éŸ³æ€»æ•°_mean']:.2f}")
```

### ç¤ºä¾‹ 3ï¼šä½¿ç”¨ datasKey

```python
data = {
    "metric_api_address": "http://localhost:8083",
    "JWT": "Bearer xxx",
    "data": {
        "datasKey": "your_data_key_123",  # ä»æ•°æ®æ± è·å–
        "target_columns": ["é”€å”®é¢"],
        "date_column": "æ—¥æœŸ"
    }
}

response = requests.post(url, json=data)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. åˆ†ç»„è¶‹åŠ¿é…ç½®

**é”™è¯¯é…ç½®ï¼š**

```json
{
  "date_column": "æœˆä»½",
  "group_by": ["æœˆä»½", "äº§å“ç±»å‹"]  // âŒ åŒ…å«æ—¥æœŸå­—æ®µ
}
```

**æ­£ç¡®é…ç½®ï¼š**

```json
{
  "date_column": "æœˆä»½",
  "group_by": ["äº§å“ç±»å‹"]  // âœ… ä¸åŒ…å«æ—¥æœŸå­—æ®µ
}
```

**åŸå› ï¼š** å¦‚æœåˆ†ç»„å­—æ®µåŒ…å«æ—¥æœŸå­—æ®µï¼Œä¼šå¯¼è‡´æ¯ä¸ªç»„å†…åªæœ‰ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œæ— æ³•è¿›è¡Œè¶‹åŠ¿åˆ†æã€‚

### 2. æ•°æ®æ ¼å¼è¦æ±‚

- æ—¥æœŸå­—æ®µæ”¯æŒæ ¼å¼ï¼š`YYYY-MM-DD`, `YYYY-MM`, `YYYY-MM-DDTHH:MM:SSZ`
- æŒ‡æ ‡åˆ—å¿…é¡»æ˜¯æ•°å€¼ç±»å‹æˆ–å¯è½¬æ¢ä¸ºæ•°å€¼çš„å­—ç¬¦ä¸²
- è‡³å°‘éœ€è¦ 2 ä¸ªæ•°æ®ç‚¹æ‰èƒ½è¿›è¡Œè¶‹åŠ¿åˆ†æ

### 3. æ€§èƒ½è€ƒè™‘

- å¤§æ•°æ®é›†å»ºè®®ä½¿ç”¨ `datasKey` æ–¹å¼ï¼Œé¿å…åœ¨è¯·æ±‚ä¸­ä¼ è¾“å¤§é‡æ•°æ®
- åˆ†ç»„æ•°é‡è¿‡å¤šæ—¶ï¼Œåˆ†ç»„è¶‹åŠ¿åˆ†æå¯èƒ½è€—æ—¶è¾ƒé•¿
- è¶…æ—¶è®¾ç½®å»ºè®® 60 ç§’ä»¥ä¸Š

## ğŸ” API æ–‡æ¡£

éƒ¨ç½²åå¯è®¿é—® Swagger æ–‡æ¡£ï¼š

```
http://your-server:8083/docs
```

æŸ¥æ‰¾ "ç»¼åˆæ•°æ®åˆ†æ" æ¥å£ï¼Œå¯æŸ¥çœ‹å®Œæ•´çš„å‚æ•°è¯´æ˜å’Œç¤ºä¾‹ã€‚

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
python test_comprehensive_api.py
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `api/search_api.py` - API è·¯ç”±å®šä¹‰ï¼ˆç¬¬ 1077-1237 è¡Œï¼‰
- `core/models.py` - æ•°æ®æ¨¡å‹å®šä¹‰ï¼ˆç¬¬ 183-212 è¡Œï¼‰
- `cal.py` - æ ¸å¿ƒåˆ†æé€»è¾‘ï¼ˆç¬¬ 472-565 è¡Œï¼‰
- `test_comprehensive_api.py` - API æµ‹è¯•è„šæœ¬

## ğŸš€ éƒ¨ç½²

API ä¼šéšä¸»æœåŠ¡ä¸€èµ·éƒ¨ç½²ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚ç¡®ä¿ï¼š

1. `cal.py` æ–‡ä»¶åœ¨é¡¹ç›®æ ¹ç›®å½•
2. å·²å®‰è£…ä¾èµ–ï¼š`numpy`, `scipy`, `requests`
3. æœåŠ¡æ­£å¸¸å¯åŠ¨

## ğŸ“Š è¿”å›æ•°æ®å¤§å°

å…¸å‹å“åº”å¤§å°ï¼ˆJSONï¼‰ï¼š

- åŸºç¡€åˆ†æï¼ˆ1æŒ‡æ ‡ï¼‰ï¼š~2-5 KB
- å«åˆ†ç»„ï¼ˆ10ç»„ï¼‰ï¼š~10-20 KB
- å«åˆ†ç»„è¶‹åŠ¿ï¼š~30-50 KB

å»ºè®®ï¼šå¤§è§„æ¨¡åˆ†ç»„åˆ†ææ—¶è€ƒè™‘åˆ†é¡µæˆ–é™åˆ¶è¿”å›ç»„æ•°ã€‚
