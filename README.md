# å…ƒæ•°æ®æœç´¢ç³»ç»Ÿ V4 - ç»´åº¦å€¼ç´¢å¼•å¢å¼ºç‰ˆ

ğŸš€ **å…¨æ–°å‡çº§çš„å…ƒæ•°æ®æœç´¢ç³»ç»Ÿï¼Œæ”¯æŒæ··åˆæ£€ç´¢ã€æ™ºèƒ½åˆ†è¯å’Œç»´åº¦å€¼ç´¢å¼•**

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ” æ··åˆæ£€ç´¢æŠ€æœ¯

- **Elasticsearchå…¨æ–‡æœç´¢**: å¼ºå¤§çš„åˆ†è¯å’Œç›¸å…³æ€§è¯„åˆ†
- **ACè‡ªåŠ¨æœºç²¾ç¡®åŒ¹é…**: é«˜é€Ÿå­—ç¬¦ä¸²åŒ¹é…ï¼Œæ”¯æŒå¤šæ¨¡å¼åŒ¹é…
- **ç›¸ä¼¼åº¦åŒ¹é…**: åŸºäºæ–‡æœ¬ç›¸ä¼¼åº¦çš„è¯­ä¹‰æœç´¢
- **ç»´åº¦å€¼æœç´¢**: ğŸ†• å¯¹ç»´åº¦å­—æ®µçš„å…·ä½“å€¼è¿›è¡Œç²¾ç¡®æœç´¢
- **æ™ºèƒ½ç»“æœåˆå¹¶**: å¤šå¼•æ“ç»“æœåŠ æƒåˆå¹¶ï¼Œæä¾›æœ€ä¼˜æœç´¢ä½“éªŒ

### ğŸ¯ ç»´åº¦å€¼ç´¢å¼• (æ–°åŠŸèƒ½)

- **å­—æ®µç±»å‹è¯†åˆ«**: è‡ªåŠ¨åŒºåˆ† `dimension` å’Œ `metric` å­—æ®µç±»å‹
- **ç»´åº¦å€¼æå–**: ä»æºæ•°æ®åº“(MySQL/PostgreSQL)ä¸­æå–ç»´åº¦åˆ—çš„æ‰€æœ‰å¯èƒ½å€¼
- **ç»´åº¦å€¼ç´¢å¼•**: ä¸ºç»´åº¦å€¼å»ºç«‹ç‹¬ç«‹çš„Elasticsearchç´¢å¼•ï¼Œæ”¯æŒå¿«é€Ÿæ£€ç´¢
- **å¤šæ•°æ®æºæ”¯æŒ**: æ”¯æŒä»å¤šä¸ªæ•°æ®åº“æºå¹¶è¡Œæå–ç»´åº¦å€¼
- **æ™ºèƒ½æ¨æ–­**: å¯¹äºç¼ºå°‘ `field_type` å­—æ®µçš„å†å²æ•°æ®ï¼Œè‡ªåŠ¨æ¨æ–­å­—æ®µç±»å‹

### ğŸ›ï¸ æ™ºèƒ½åˆ†è¯æ§åˆ¶

- **å¯æ§åˆ†è¯**: æ”¯æŒå¼€å¯/å…³é—­åˆ†è¯ï¼Œé€‚åº”ä¸åŒæœç´¢åœºæ™¯
- **å¤šåˆ†è¯å™¨æ”¯æŒ**: IKä¸­æ–‡åˆ†è¯å™¨(ik_max_word/ik_smart)å’Œæ ‡å‡†åˆ†è¯å™¨
- **åœºæ™¯é€‚é…**:
  - å¯ç”¨åˆ†è¯ï¼šé€‚åˆå¤æ‚æŸ¥è¯¢å’Œé•¿æ–‡æœ¬æœç´¢
  - ç¦ç”¨åˆ†è¯ï¼šé€‚åˆä¸“ä¸šæœ¯è¯­å’Œç²¾ç¡®åŒ¹é…

### âš¡ ä¸€é”®éƒ¨ç½²

- **è‡ªåŠ¨ç´¢å¼•åˆ›å»º**: ä¸€é”®åˆ›å»ºå­—æ®µç´¢å¼•å’Œç»´åº¦å€¼ç´¢å¼•
- **æ•°æ®è‡ªåŠ¨åŠ è½½**: ä»Excelæ–‡ä»¶è‡ªåŠ¨å¯¼å…¥å…ƒæ•°æ®
- **ç»´åº¦å€¼è‡ªåŠ¨æå–**: è‡ªåŠ¨ä»æ•°æ®åº“æå–å¹¶ç´¢å¼•ç»´åº¦å€¼
- **å¤šå¼•æ“åˆå§‹åŒ–**: åŒæ—¶åˆå§‹åŒ–ESã€ACè‡ªåŠ¨æœºã€ç›¸ä¼¼åº¦åŒ¹é…å™¨

### ğŸ”„ æ‰¹é‡æŸ¥è¯¢ API (æ–°åŠŸèƒ½)

- **æ‰¹é‡å¤„ç†**: æ”¯æŒä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªé—®é¢˜
- **å¹¶è¡Œæ‰§è¡Œ**: ä½¿ç”¨å¤šçº¿ç¨‹å¹¶è¡Œè°ƒç”¨ Dify API
- **çµæ´»é…ç½®**: å¯è‡ªå®šä¹‰å¹¶å‘æ•°å’Œè¶…æ—¶æ—¶é—´
- **é”™è¯¯å®¹é”™**: éƒ¨åˆ†å¤±è´¥ä¸å½±å“å…¶ä»–é—®é¢˜å¤„ç†
- **å®Œæ•´å“åº”**: è¿”å›æ¯ä¸ªé—®é¢˜çš„ç­”æ¡ˆå’Œå®Œæ•´ API å“åº”

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
å…ƒæ•°æ®æœç´¢ç³»ç»Ÿ V4
â”œâ”€â”€ ğŸ” æ··åˆæœç´¢å±‚
â”‚   â”œâ”€â”€ ElasticsearchEngine    # ESå…¨æ–‡æœç´¢ + ç»´åº¦å€¼æœç´¢
â”‚   â”œâ”€â”€ ACMatcher             # ACè‡ªåŠ¨æœºåŒ¹é…
â”‚   â”œâ”€â”€ SimilarityMatcher     # ç›¸ä¼¼åº¦åŒ¹é…
â”‚   â””â”€â”€ HybridSearcher        # æ··åˆæœç´¢æ§åˆ¶å™¨
â”œâ”€â”€ ğŸ“Š æ•°æ®å±‚
â”‚   â”œâ”€â”€ MetadataLoader        # Excelæ•°æ®åŠ è½½å™¨
â”‚   â”œâ”€â”€ DatabaseManager       # æ•°æ®åº“è¿æ¥ç®¡ç†å™¨ (æ–°å¢)
â”‚   â””â”€â”€ DimensionExtractor    # ç»´åº¦å€¼æå–å™¨ (æ–°å¢)
â”œâ”€â”€ ğŸŒ APIå±‚
â”‚   â”œâ”€â”€ SearchAPI             # ç»Ÿä¸€æœç´¢æ¥å£
â”‚   â”œâ”€â”€ DimensionAPI          # ç»´åº¦å€¼æœç´¢æ¥å£ (æ–°å¢)
â”‚   â””â”€â”€ DatabaseAPI           # æ•°æ®åº“ç®¡ç†æ¥å£ (æ–°å¢)
â””â”€â”€ ğŸ’¾ å­˜å‚¨å±‚
    â”œâ”€â”€ Elasticsearch         # å­—æ®µç´¢å¼•å­˜å‚¨
    â””â”€â”€ Elasticsearch         # ç»´åº¦å€¼ç´¢å¼•å­˜å‚¨ (æ–°å¢)
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…Pythonä¾èµ–
pip install -r requirements.txt

# å¯åŠ¨Elasticsearch (Dockeræ–¹å¼)
docker run -d \
  --name elasticsearch \
  -p 9200:9200 \
  -p 9300:9300 \
  -e "discovery.type=single-node" \
  -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
  elasticsearch:8.11.0

# å®‰è£…IKä¸­æ–‡åˆ†è¯å™¨ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰
docker exec -it elasticsearch elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v8.11.0/elasticsearch-analysis-ik-8.11.0.zip
docker restart elasticsearch
```

### 2. é…ç½®ç³»ç»Ÿ

å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š

```bash
cp config.env.example config.env
```

ç¼–è¾‘ `config.env`ï¼š

```env
# Elasticsearché…ç½®
ES_HOST=localhost
ES_PORT=9200
ES_INDEX_PREFIX=metadata_v4

# APIé…ç½®
API_HOST=0.0.0.0
API_PORT=8082

# æ•°æ®æ–‡ä»¶é…ç½®
METADATA_EXCEL_PATH=å®¢æ»¡-å…ƒæ•°æ®è¡¨.xlsx

# æ··åˆæœç´¢æƒé‡
ES_WEIGHT=1.0
AC_WEIGHT=0.9
SIM_WEIGHT=0.8

# åˆ†è¯å™¨é…ç½®
DEFAULT_TOKENIZER=ik_max_word
DEFAULT_SEARCH_ANALYZER=ik_smart

# æ•°æ®åº“è¿æ¥é…ç½® (æ–°å¢ - ç”¨äºç»´åº¦å€¼æå–)
DB_TYPE=mysql
DB_HOST=localhost
DB_PORT=3306
DB_USER=your_username
DB_PASSWORD=your_password
DB_DATABASE=your_database

# ç»´åº¦å€¼ç´¢å¼•é…ç½® (æ–°å¢)
DIMENSION_VALUE_INDEXING_ENABLED=true
MAX_VALUES_PER_COLUMN=1000
AUTO_EXTRACT_DIMENSIONS=true
```

### 3. å…ƒæ•°æ®è¡¨æ ¼å¼

æ‚¨çš„Excelå…ƒæ•°æ®è¡¨ç°åœ¨æ”¯æŒä»¥ä¸‹å­—æ®µï¼ˆ**æ–°å¢å­—æ®µç±»å‹åˆ—**ï¼‰ï¼š

| åˆ—å               | å¿…éœ€ | è¯´æ˜                        |
| ------------------ | ---- | --------------------------- |
| æ‰€å±è¡¨             | âœ…   | æ•°æ®è¡¨å                    |
| åˆ—å               | âœ…   | å­—æ®µå                      |
| æ˜¾ç¤ºåç§°           | âœ…   | ä¸­æ–‡æ˜¾ç¤ºå                  |
| **å­—æ®µç±»å‹** | ğŸ†•   | `dimension` æˆ– `metric` |
| åŒä¹‰è¯/åˆ«å        | âŒ   | JSONæ•°ç»„æ ¼å¼                |
| å­—æ®µæè¿°           | âŒ   | å­—æ®µè¯´æ˜                    |
| æ•°æ®ç±»å‹           | âŒ   | text/number/datetime        |
| æ˜¯å¦å®ä½“           | âŒ   | å¸ƒå°”å€¼                      |
| æ˜¯å¦å¯ç”¨           | âŒ   | å¸ƒå°”å€¼                      |

**å­—æ®µç±»å‹è¯´æ˜ï¼š**

- `dimension`: ç»´åº¦å­—æ®µï¼Œç³»ç»Ÿä¼šä»æ•°æ®åº“ä¸­æå–å…¶æ‰€æœ‰å¯èƒ½å€¼å¹¶å»ºç«‹ç´¢å¼•
- `metric`: æŒ‡æ ‡å­—æ®µï¼Œä»…å¯¹å­—æ®µåå»ºç«‹ç´¢å¼•ï¼Œä¸æå–å…·ä½“å€¼

### 4. å¯åŠ¨ç³»ç»Ÿ

```bash
python run.py
```

ç³»ç»Ÿå°†åœ¨ http://localhost:8082 å¯åŠ¨

### 5. ä¸€é”®åˆå§‹åŒ–

è®¿é—® API æ–‡æ¡£: http://localhost:8082/docs

è°ƒç”¨åˆå§‹åŒ–æ¥å£ï¼š

```bash
curl -X POST "http://localhost:8082/api/search/index/create" \
  -H "Content-Type: application/json" \
  -d '{
    "force_recreate": true,
    "auto_load_data": true
  }'
```

## ğŸ” API ä½¿ç”¨æŒ‡å—

### åŸºç¡€å­—æ®µæœç´¢

```bash
# æ··åˆæœç´¢ï¼ˆæ¨èï¼‰
curl "http://localhost:8082/api/search/fields?q=å®¢æˆ·ç¼–ç &search_method=hybrid"

# åˆ†è¯æœç´¢
curl "http://localhost:8082/api/search/fields?q=å®¢æˆ·ç¼–ç &use_tokenization=true&tokenizer_type=ik_max_word"

# ç²¾ç¡®åŒ¹é…ï¼ˆä¸åˆ†è¯ï¼‰
curl "http://localhost:8082/api/search/fields?q=å®¢æˆ·ç¼–ç &use_tokenization=false"
```

### ğŸ†• ç»´åº¦å€¼æœç´¢

```bash
# æœç´¢ç»´åº¦å€¼
curl "http://localhost:8082/api/search/dimension-values?q=å·²å®Œæˆ"

# é™åˆ¶è¡¨åæœç´¢
curl "http://localhost:8082/api/search/dimension-values?q=VIP&table_name=customer_info"

# é™åˆ¶åˆ—åæœç´¢
curl "http://localhost:8082/api/search/dimension-values?q=åŒ—äº¬&column_name=region"
```

### é«˜çº§æœç´¢

```bash
# POSTæ–¹å¼å¤æ‚æŸ¥è¯¢
curl -X POST "http://localhost:8082/api/search/fields" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "å®¢æˆ·ä¿¡æ¯",
    "search_method": "hybrid",
    "use_tokenization": true,
    "tokenizer_type": "ik_smart",
    "table_name": "dwd_customer_info",
    "entity_only": true,
    "size": 20
  }'

# ç»´åº¦å€¼POSTæœç´¢
curl -X POST "http://localhost:8082/api/search/dimension-values" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "å·²å®Œæˆ",
    "table_name": "order_status",
    "use_tokenization": false,
    "size": 10
  }'
```

### ğŸ†• æ‰¹é‡æŸ¥è¯¢ API

æ‰¹é‡æŸ¥è¯¢ API å…è®¸æ‚¨ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªé—®é¢˜ï¼Œå¹¶è¡Œè°ƒç”¨ Dify APIï¼Œé€‚ç”¨äºæ‰¹é‡æ•°æ®å¤„ç†åœºæ™¯ã€‚

```bash
# æ‰¹é‡æŸ¥è¯¢é—®é¢˜
curl -X POST "http://localhost:8082/api/search/batch-query" \
  -H "Content-Type: application/json" \
  -d '{
    "questions": ["é—®é¢˜1", "é—®é¢˜2", "é—®é¢˜3"],
    "api_url": "https://ai-aidq.sany.com.cn/v1/chat-messages",
    "jwt": "app-xxx",
    "jwt_chat": "Bearer xxx",
    "max_workers": 5,
    "timeout": 400
  }'
```

**å“åº”æ ¼å¼**:

```json
{
    "success": true,
    "results": [
        {
            "id": 1,
            "question": "é—®é¢˜1",
            "answer": "è¿™æ˜¯ç­”æ¡ˆ...",
            "response": {...},
            "status": "success",
            "error": null,
            "timestamp": "2024-01-01T12:00:00"
        }
    ],
    "total": 3,
    "success_count": 3,
    "error_count": 0,
    "took": 5234
}
```

**å‚æ•°è¯´æ˜**:

- `questions`: é—®é¢˜åˆ—è¡¨ (å¿…å¡«)
- `api_url`: Dify API URL (å¿…å¡«)
- `jwt`: JWT token (å¿…å¡«)
- `jwt_chat`: èŠå¤© JWT token (å¿…å¡«)
- `max_workers`: å¹¶å‘çº¿ç¨‹æ•°ï¼ŒèŒƒå›´ 1-20 (é»˜è®¤: 5)
- `timeout`: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼ŒèŒƒå›´ 10-600 (é»˜è®¤: 400)

è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒ: [BATCH_QUERY_API.md](BATCH_QUERY_API.md)

### ğŸ†• æ•°æ®åº“ç®¡ç†

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
curl "http://localhost:8082/api/search/database/test"

# éªŒè¯ç»´åº¦å­—æ®µ
curl "http://localhost:8082/api/search/dimension/validate"

# æ‰‹åŠ¨æå–ç»´åº¦å€¼
curl -X POST "http://localhost:8082/api/search/dimension/extract?force_recreate=false"

# è·å–ç»´åº¦é…ç½®
curl "http://localhost:8082/api/search/config/dimension"
```

### ç³»ç»Ÿç®¡ç†

```bash
# è·å–ç³»ç»ŸçŠ¶æ€
curl "http://localhost:8082/api/search/stats"

# å¥åº·æ£€æŸ¥
curl "http://localhost:8082/api/search/health"

# éªŒè¯æ•°æ®æ–‡ä»¶
curl "http://localhost:8082/api/search/validate"
```

## ğŸ“ æœç´¢æ–¹æ³•å¯¹æ¯”

| æœç´¢æ–¹æ³•                      | ä¼˜åŠ¿                       | é€‚ç”¨åœºæ™¯           | æ€§èƒ½       |
| ----------------------------- | -------------------------- | ------------------ | ---------- |
| **hybrid**              | ç»¼åˆå¤šç§ç®—æ³•ä¼˜åŠ¿           | é€šç”¨æœç´¢ï¼Œæ¨èä½¿ç”¨ | â­â­â­â­â­ |
| **elasticsearch**       | å¼ºå¤§çš„å…¨æ–‡æœç´¢å’Œç›¸å…³æ€§è¯„åˆ† | å¤æ‚æ–‡æœ¬æŸ¥è¯¢       | â­â­â­â­   |
| **dimension_values** ğŸ†• | ç²¾ç¡®çš„ç»´åº¦å€¼åŒ¹é…           | æŸ¥æ‰¾å…·ä½“çš„ç»´åº¦å€¼   | â­â­â­â­â­ |
| **ac_matcher**          | æå¿«çš„ç²¾ç¡®åŒ¹é…             | å·²çŸ¥æœ¯è¯­æŸ¥æ‰¾       | â­â­â­â­â­ |
| **similarity**          | è¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é…             | æ¨¡ç³ŠæŸ¥è¯¢           | â­â­â­     |

## ğŸ¯ ç»´åº¦å€¼ç´¢å¼•ä½¿ç”¨åœºæ™¯

### ä»€ä¹ˆæ˜¯ç»´åº¦å€¼ç´¢å¼•ï¼Ÿ

ç»´åº¦å€¼ç´¢å¼•æ˜¯V4ç‰ˆæœ¬çš„æ ¸å¿ƒæ–°åŠŸèƒ½ï¼Œå®ƒä¼šï¼š

1. **è¯†åˆ«ç»´åº¦å­—æ®µ**: è‡ªåŠ¨è¯†åˆ«æˆ–æ‰‹åŠ¨æ ‡è®°ä¸º `dimension` ç±»å‹çš„å­—æ®µ
2. **æå–æ‰€æœ‰å¯èƒ½å€¼**: ä»æºæ•°æ®åº“ä¸­æŸ¥è¯¢è¯¥å­—æ®µçš„æ‰€æœ‰ DISTINCT å€¼
3. **å»ºç«‹ç‹¬ç«‹ç´¢å¼•**: ä¸ºè¿™äº›å€¼åˆ›å»ºä¸“é—¨çš„Elasticsearchç´¢å¼•
4. **æ”¯æŒç²¾ç¡®æœç´¢**: ç”¨æˆ·å¯ä»¥ç›´æ¥æœç´¢è¿™äº›å…·ä½“çš„ç»´åº¦å€¼

### å…¸å‹ä½¿ç”¨åœºæ™¯

**åœºæ™¯1: è®¢å•çŠ¶æ€æŸ¥è¯¢**

- å­—æ®µï¼š`order_status` (ç»´åº¦å­—æ®µ)
- å¯èƒ½å€¼ï¼š`å¾…ä»˜æ¬¾`ã€`å·²ä»˜æ¬¾`ã€`é…é€ä¸­`ã€`å·²å®Œæˆ`ã€`å·²å–æ¶ˆ`
- æœç´¢ï¼šç”¨æˆ·è¾“å…¥"å·²å®Œæˆ"å¯ä»¥ç›´æ¥æ‰¾åˆ°ç›¸å…³çš„çŠ¶æ€å­—æ®µ

**åœºæ™¯2: åœ°åŒºä¿¡æ¯æŸ¥è¯¢**

- å­—æ®µï¼š`region` (ç»´åº¦å­—æ®µ)
- å¯èƒ½å€¼ï¼š`åŒ—äº¬`ã€`ä¸Šæµ·`ã€`å¹¿å·`ã€`æ·±åœ³`...
- æœç´¢ï¼šç”¨æˆ·è¾“å…¥"åŒ—äº¬"å¯ä»¥æ‰¾åˆ°æ‰€æœ‰åŒ…å«åŒ—äº¬åœ°åŒºçš„ç›¸å…³å­—æ®µ

**åœºæ™¯3: ç”¨æˆ·ç­‰çº§æŸ¥è¯¢**

- å­—æ®µï¼š`user_level` (ç»´åº¦å­—æ®µ)
- å¯èƒ½å€¼ï¼š`æ™®é€šç”¨æˆ·`ã€`VIPç”¨æˆ·`ã€`é’»çŸ³ç”¨æˆ·`
- æœç´¢ï¼šç”¨æˆ·è¾“å…¥"VIP"å¯ä»¥ç²¾ç¡®åŒ¹é…åˆ°ç”¨æˆ·ç­‰çº§ç›¸å…³å­—æ®µ

## ğŸ“Š æœç´¢å“åº”æ ¼å¼

### å­—æ®µæœç´¢å“åº”

```json
{
  "query": "å®¢æˆ·ç¼–ç ",
  "total": 15,
  "took": 45,
  "search_methods": ["elasticsearch", "ac_matcher", "similarity"],
  "tokenization_used": true,
  "tokenizer_type": "ik_max_word",
  "results": [
    {
      "field": {
        "table_name": "dwd_customer_info",
        "column_name": "customer_code",
        "display_name": "å®¢æˆ·ç¼–ç ",
        "field_type": "dimension",
        "synonyms": ["å®¢æˆ·å”¯ä¸€ID", "customer_code"],
        "description": "å®¢æˆ·å”¯ä¸€æ ‡è¯†ç¼–ç ",
        "is_entity": true,
        "is_enabled": true
      },
      "score": 8.234567,
      "matched_text": "display_name: å®¢æˆ·ç¼–ç ",
      "search_method": "elasticsearch",
      "highlight": {
        "display_name": ["<em>å®¢æˆ·ç¼–ç </em>"]
      }
    }
  ]
}
```

### ğŸ†• ç»´åº¦å€¼æœç´¢å“åº”

```json
{
  "query": "å·²å®Œæˆ",
  "total": 3,
  "took": 12,
  "search_methods": ["dimension_values"],
  "results": [
    {
      "field": {
        "table_name": "order_info",
        "column_name": "order_status",
        "display_name": "è®¢å•çŠ¶æ€",
        "field_type": "dimension",
        "description": "ç»´åº¦å€¼: å·²å®Œæˆ"
      },
      "score": 9.876543,
      "matched_text": "ç»´åº¦å€¼: å·²å®Œæˆ",
      "search_method": "dimension_values",
      "extra_info": {
        "dimension_value": "å·²å®Œæˆ",
        "frequency": 15420,
        "value_hash": "abc123def456"
      }
    }
  ]
}
```

## ğŸ› ï¸ é¡¹ç›®ç»“æ„

```
es_search_system_v4/
â”œâ”€â”€ api/                    # APIæ¥å£å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py            # FastAPIä¸»åº”ç”¨
â”‚   â””â”€â”€ search_api.py      # æœç´¢APIè·¯ç”± (å·²æ‰©å±•)
â”œâ”€â”€ core/                  # æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py          # é…ç½®ç®¡ç† (å·²æ‰©å±•)
â”‚   â”œâ”€â”€ models.py          # æ•°æ®æ¨¡å‹ (å·²æ‰©å±•)
â”‚   â””â”€â”€ database.py        # æ•°æ®åº“è¿æ¥æŠ½è±¡å±‚ (æ–°å¢)
â”œâ”€â”€ search/                # æœç´¢å¼•æ“å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ elasticsearch_engine.py  # ESæœç´¢å¼•æ“ (å·²æ‰©å±•)
â”‚   â”œâ”€â”€ ac_matcher.py           # ACè‡ªåŠ¨æœº
â”‚   â”œâ”€â”€ similarity_matcher.py   # ç›¸ä¼¼åº¦åŒ¹é…
â”‚   â””â”€â”€ hybrid_searcher.py      # æ··åˆæœç´¢å™¨ (å·²æ‰©å±•)
â”œâ”€â”€ indexing/              # æ•°æ®ç´¢å¼•å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ data_loader.py     # Excelæ•°æ®åŠ è½½å™¨ (å·²æ‰©å±•)
â”‚   â””â”€â”€ dimension_extractor.py  # ç»´åº¦å€¼æå–å™¨ (æ–°å¢)
â”œâ”€â”€ config.env.example     # é…ç½®æ–‡ä»¶æ¨¡æ¿ (å·²æ‰©å±•)
â”œâ”€â”€ requirements.txt       # Pythonä¾èµ– (å·²æ‰©å±•)
â”œâ”€â”€ run.py                # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ README.md             # é¡¹ç›®æ–‡æ¡£ (å·²é‡å†™)
â””â”€â”€ å®¢æ»¡-å…ƒæ•°æ®è¡¨.xlsx    # å…ƒæ•°æ®æ–‡ä»¶
```

## âš™ï¸ é«˜çº§é…ç½®

### ç»´åº¦å€¼ç´¢å¼•é…ç½®

```env
# å¯ç”¨/ç¦ç”¨ç»´åº¦å€¼ç´¢å¼•
DIMENSION_VALUE_INDEXING_ENABLED=true

# æ¯åˆ—æœ€å¤§æå–å€¼æ•°é‡
MAX_VALUES_PER_COLUMN=1000

# æ‰¹é‡å¤„ç†å¤§å°
DIMENSION_BATCH_SIZE=100

# æ˜¯å¦åœ¨ç´¢å¼•åˆ›å»ºæ—¶è‡ªåŠ¨æå–ç»´åº¦å€¼
AUTO_EXTRACT_DIMENSIONS=true
```

### å¤šæ•°æ®åº“é…ç½®

æ”¯æŒä»å¤šä¸ªæ•°æ®åº“æºæå–ç»´åº¦å€¼ï¼š

```env
# æ–¹å¼1: ç¯å¢ƒå˜é‡ (å•ä¸ªæ•°æ®åº“)
DB_TYPE=mysql
DB_HOST=localhost
DB_PORT=3306
DB_USER=username
DB_PASSWORD=password
DB_DATABASE=database

# æ–¹å¼2: JSONé…ç½® (å¤šä¸ªæ•°æ®åº“)
DATABASE_CONFIGS_JSON={"source1":{"type":"mysql","host":"host1","port":3306,"user":"user1","password":"pass1","database":"db1"},"source2":{"type":"postgresql","host":"host2","port":5432,"user":"user2","password":"pass2","database":"db2"}}
```

### æ··åˆæœç´¢æƒé‡è°ƒä¼˜

```env
# è°ƒæ•´å„æœç´¢å¼•æ“æƒé‡
ES_WEIGHT=1.0        # Elasticsearchæƒé‡
AC_WEIGHT=0.9        # ACè‡ªåŠ¨æœºæƒé‡  
SIM_WEIGHT=0.8       # ç›¸ä¼¼åº¦åŒ¹é…æƒé‡
```

### åˆ†è¯å™¨é€‰æ‹©

```env
# IKæœ€å¤§è¯é•¿åˆ†è¯å™¨ï¼ˆæ¨èï¼‰
DEFAULT_TOKENIZER=ik_max_word

# IKæ™ºèƒ½åˆ†è¯å™¨ï¼ˆæ›´ç²¾å‡†ï¼‰
DEFAULT_TOKENIZER=ik_smart

# æ ‡å‡†åˆ†è¯å™¨ï¼ˆè‹±æ–‡ï¼‰
DEFAULT_TOKENIZER=standard
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Elasticsearchè¿æ¥å¤±è´¥**

   ```bash
   # æ£€æŸ¥ESæœåŠ¡çŠ¶æ€
   curl http://localhost:9200/_cluster/health
   ```
2. **æ•°æ®åº“è¿æ¥å¤±è´¥**

   ```bash
   # æµ‹è¯•æ•°æ®åº“è¿æ¥
   curl http://localhost:8082/api/search/database/test
   ```
3. **ç»´åº¦å€¼æå–å¤±è´¥**

   ```bash
   # éªŒè¯ç»´åº¦å­—æ®µ
   curl http://localhost:8082/api/search/dimension/validate
   ```
4. **IKåˆ†è¯å™¨ä¸å¯ç”¨**

   ```bash
   # å®‰è£…IKåˆ†è¯å™¨
   docker exec -it elasticsearch elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v8.11.0/elasticsearch-analysis-ik-8.11.0.zip
   docker restart elasticsearch
   ```

### æ€§èƒ½ä¼˜åŒ–

1. **Elasticsearchä¼˜åŒ–**

   ```bash
   # å¢åŠ ESå†…å­˜
   docker run -e "ES_JAVA_OPTS=-Xms1g -Xmx1g" elasticsearch:8.11.0
   ```
2. **ç»´åº¦å€¼ç´¢å¼•ä¼˜åŒ–**

   - è°ƒæ•´ `MAX_VALUES_PER_COLUMN` é™åˆ¶æ¯åˆ—æå–çš„å€¼æ•°é‡
   - ä½¿ç”¨ `DIMENSION_BATCH_SIZE` æ§åˆ¶æ‰¹é‡å¤„ç†å¤§å°
   - åˆç†é…ç½®æ•°æ®åº“è¿æ¥æ± 
3. **æœç´¢æ€§èƒ½è°ƒä¼˜**

   - è°ƒæ•´æœç´¢å¼•æ“æƒé‡
   - é™åˆ¶æœç´¢ç»“æœæ•°é‡
   - ä½¿ç”¨è¡¨åè¿‡æ»¤å‡å°‘æœç´¢èŒƒå›´

## ğŸ“ˆ ç‰ˆæœ¬æ›´æ–°

### V4.0.0 æ–°ç‰¹æ€§

- âœ… **ç»´åº¦å€¼ç´¢å¼•**: æ”¯æŒä»æ•°æ®åº“æå–ç»´åº¦å€¼å¹¶å»ºç«‹ç´¢å¼•
- âœ… **å¤šæ•°æ®åº“æ”¯æŒ**: æ”¯æŒMySQLå’ŒPostgreSQLæ•°æ®æº
- âœ… **å­—æ®µç±»å‹è¯†åˆ«**: è‡ªåŠ¨åŒºåˆ†dimensionå’Œmetricå­—æ®µ
- âœ… **æ•°æ®åº“è¿æ¥ç®¡ç†**: æŠ½è±¡åŒ–æ•°æ®åº“è¿æ¥å±‚
- âœ… **ç»´åº¦å€¼æœç´¢API**: ä¸“é—¨çš„ç»´åº¦å€¼æœç´¢æ¥å£
- âœ… **é…ç½®å¢å¼º**: æ”¯æŒç»´åº¦å€¼ç´¢å¼•ç›¸å…³é…ç½®
- âœ… **å‘åå…¼å®¹**: å®Œå…¨å…¼å®¹V3ç‰ˆæœ¬åŠŸèƒ½

### ä»V3å‡çº§åˆ°V4

V4ç‰ˆæœ¬å®Œå…¨å‘åå…¼å®¹V3ï¼Œå‡çº§æ­¥éª¤ï¼š

1. **æ›´æ–°ä»£ç **: æ‹‰å–V4ç‰ˆæœ¬ä»£ç 
2. **å®‰è£…ä¾èµ–**: `pip install -r requirements.txt`
3. **æ›´æ–°é…ç½®**: æ·»åŠ æ•°æ®åº“è¿æ¥é…ç½®ï¼ˆå¯é€‰ï¼‰
4. **é‡å¯ç³»ç»Ÿ**: `python run.py`
5. **æµ‹è¯•åŠŸèƒ½**: è®¿é—® `/docs` æŸ¥çœ‹æ–°å¢API

**æ³¨æ„**: å¦‚æœä¸é…ç½®æ•°æ®åº“è¿æ¥ï¼Œç³»ç»Ÿä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œåªæ˜¯ä¸ä¼šæœ‰ç»´åº¦å€¼ç´¢å¼•åŠŸèƒ½ã€‚

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ï¼

### å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
git clone <repository>
cd es_search_system_v4
pip install -r requirements.txt
python run.py
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

---

**ğŸ¯ å…ƒæ•°æ®æœç´¢ç³»ç»Ÿ V4 - è®©æœç´¢æ›´æ™ºèƒ½ï¼Œè®©ç»´åº¦å€¼è§¦æ‰‹å¯åŠï¼**
